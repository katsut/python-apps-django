{% extends 'base.html' %}
{% load static %}

{% block title %}Work 12 - リアルタイムチャット{% endblock %}

{% block subtitle %}
<div class="page-subtitle">Work 12: Django Channelsを使ったリアルタイムチャットアプリ</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'work12/style.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    
    <div id="messages">
        {% for message in messages %}
        <div class="message {% if message.username == user.username %}my-message{% else %}other-message{% endif %}">
            <div class="message-header">
                <span class="username">{{ message.username }}</span>
                <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            <div class="message-content">{{ message.content|linebreaksbr }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="input-container">
        <p><strong>{{ user.username }}</strong></p>
        <textarea id="message-input" placeholder="メッセージを入力..." rows="3"></textarea>
        <button id="send-button" type="button">送信</button>
    </div>
    
    <div style="margin-top: 30px;">
        <a href="/" class="btn btn-secondary">ホームに戻る</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 現在のユーザー名を取得
    const currentUsername = '{{ user.username }}';
    
    // WebSocket接続
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/chat/';
    const socket = new WebSocket(wsUrl);
    
    // メッセージを受信したら画面に表示
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messages = document.getElementById('messages');
        
        // 自分の発言かどうかで異なるクラスを適用
        const messageClass = data.username === currentUsername ? 'my-message' : 'other-message';
        
        // 現在の時刻を取得
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                          now.getMinutes().toString().padStart(2, '0');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + messageClass;
        messageDiv.innerHTML = 
            '<div class="message-header">' +
                '<span class="username">' + data.username + '</span>' +
                '<span class="timestamp">' + timeString + '</span>' +
            '</div>' +
            '<div class="message-content">' + data.message.replace(/\n/g, '<br>') + '</div>';
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    };
    
    // 送信ボタンでメッセージ送信
    document.getElementById('send-button').onclick = function() {
        const messageInput = document.getElementById('message-input');
        if (messageInput.value.trim()) {
            socket.send(JSON.stringify({
                'message': messageInput.value
            }));
            messageInput.value = '';
        }
    };
</script>
{% endblock %}
